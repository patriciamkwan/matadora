import React, { useState, useEffect } from 'react';
import { Save, X, ChevronLeft, ChevronRight, User, TrendingUp, Trash2 } from 'lucide-react';

const WORKOUTS = {
  A: [
    { name: 'Australian Pullups', sets: 3, target: '8-10' },
    { name: 'Goblet Squats', sets: 3, target: '8-12' },
    { name: 'Superman Lateral Raise', sets: 3, target: '15' },
    { name: 'Pushups', sets: 3, target: '20' },
    { name: 'Glute Bridge Walkout', sets: 3, target: '10-15' },
    { name: 'Deadlift Rotate Romanian', sets: 3, target: '8-12' },
    { name: 'Hanging Knee Raises', sets: 3, target: '8-12' },
    { name: 'Scapular Shrugs', sets: 3, target: '15' },
    { name: 'Bench Curls', sets: 3, target: '8-14' }
  ],
  B: [
    { name: 'Pull-ups/Chin-ups', sets: 3, target: '5-8' },
    { name: 'Bulgarian Split Squats', sets: 3, target: '8-12' },
    { name: 'Pike Push-ups', sets: 3, target: '8-12' },
    { name: 'Dips', sets: 3, target: '8-12' },
    { name: 'Nordic Curls', sets: 3, target: '5-8' },
    { name: 'Single Leg Deadlift', sets: 3, target: '8-12' },
    { name: 'Leg Raises', sets: 3, target: '10-15' },
    { name: 'Plank', sets: 3, target: '45-60s' }
  ],
  C: [
    { name: 'Archer Push-ups', sets: 3, target: '6-10' },
    { name: 'Pistol Squats', sets: 3, target: '5-8' },
    { name: 'Handstand Push-ups', sets: 3, target: '3-8' },
    { name: 'Diamond Push-ups', sets: 3, target: '10-15' },
    { name: 'Single Leg Glute Bridge', sets: 3, target: '12-15' },
    { name: 'L-Sit Hold', sets: 3, target: '15-30s' },
    { name: 'Windshield Wipers', sets: 3, target: '8-12' },
    { name: 'Face Pulls', sets: 3, target: '12-15' }
  ]
};

const EFFORT = ['Easy (3+ left)', 'Medium (2 left)', 'Hard (1 left)', 'Max (0 left)'];

export default function WorkoutApp() {
  const [screen, setScreen] = useState('profiles');
  const [profiles, setProfiles] = useState([]);
  const [currentProfile, setCurrentProfile] = useState(null);
  const [newProfileName, setNewProfileName] = useState('');
  const [allWorkouts, setAllWorkouts] = useState([]);
  const [activeWorkout, setActiveWorkout] = useState(null);
  const [exerciseIndex, setExerciseIndex] = useState(0);

  useEffect(() => {
    loadProfiles();
  }, []);

  useEffect(() => {
    if (currentProfile) {
      loadAllWorkouts();
    }
  }, [currentProfile]);

  const loadProfiles = async () => {
    try {
      const res = await window.storage.get('profiles');
      if (res) setProfiles(JSON.parse(res.value));
    } catch (e) {
      console.log('No profiles');
    }
  };

  const createProfile = async () => {
    if (!newProfileName.trim()) return;
    const profile = { id: Date.now(), name: newProfileName.trim() };
    const updated = [...profiles, profile];
    await window.storage.set('profiles', JSON.stringify(updated));
    setProfiles(updated);
    setCurrentProfile(profile);
    setNewProfileName('');
    setScreen('home');
  };

  const loadAllWorkouts = async () => {
    if (!currentProfile) return;
    try {
      const keys = await window.storage.list('workout:');
      const workouts = [];
      if (keys?.keys) {
        for (const key of keys.keys) {
          const res = await window.storage.get(key);
          if (res) workouts.push(JSON.parse(res.value));
        }
      }
      setAllWorkouts(workouts.sort((a, b) => new Date(b.date) - new Date(a.date)));
    } catch (e) {
      console.log('No workouts');
      setAllWorkouts([]);
    }
  };

  const startWorkout = (type) => {
    const exercises = WORKOUTS[type].map(ex => ({
      name: ex.name,
      target: ex.target,
      sets: Array(ex.sets).fill(null).map(() => ({ reps: '', weight: '', effort: null }))
    }));
    setActiveWorkout({
      id: Date.now(),
      profileId: currentProfile.id,
      profileName: currentProfile.name,
      type,
      date: new Date().toISOString().split('T')[0],
      exercises
    });
    setExerciseIndex(0);
    setScreen('workout');
  };

  const saveWorkout = async () => {
    await window.storage.set(`workout:${activeWorkout.id}`, JSON.stringify(activeWorkout));
    await loadAllWorkouts();
    setActiveWorkout(null);
    setExerciseIndex(0);
    setScreen('home');
  };

  const exitWorkout = () => {
    if (confirm('Exit without saving?')) {
      setActiveWorkout(null);
      setExerciseIndex(0);
      setScreen('home');
    }
  };

  const updateSet = (setIdx, field, value) => {
    const updated = { ...activeWorkout };
    updated.exercises[exerciseIndex].sets[setIdx][field] = value;
    setActiveWorkout(updated);
  };

  const deleteWorkout = async (id) => {
    if (confirm('Delete workout?')) {
      await window.storage.delete(`workout:${id}`);
      await loadAllWorkouts();
    }
  };

  const getPreviousWorkout = () => {
    if (!activeWorkout || !currentProfile) return null;
    return allWorkouts.find(w => 
      w.type === activeWorkout.type && 
      w.profileId === currentProfile.id && 
      w.id !== activeWorkout.id
    );
  };

  // PROFILE SCREEN
  if (screen === 'profiles') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-6 flex items-center justify-center">
        <div className="max-w-md w-full">
          <h1 className="text-4xl font-bold text-white text-center mb-8">Workout Tracker</h1>
          
          {profiles.length > 0 && (
            <div className="mb-8">
              <h2 className="text-white text-lg mb-3">Select Profile</h2>
              {profiles.map(p => (
                <button
                  key={p.id}
                  onClick={() => { setCurrentProfile(p); setScreen('home'); }}
                  className="w-full bg-white/10 border border-white/20 rounded-lg p-4 mb-2 text-white hover:bg-white/20 flex items-center gap-3"
                >
                  <User size={20} className="text-purple-300" />
                  {p.name}
                </button>
              ))}
            </div>
          )}

          <div>
            <h2 className="text-white text-lg mb-3">Create Profile</h2>
            <div className="flex gap-2">
              <input
                type="text"
                value={newProfileName}
                onChange={e => setNewProfileName(e.target.value)}
                onKeyPress={e => e.key === 'Enter' && createProfile()}
                placeholder="Enter name"
                className="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-purple-300"
              />
              <button
                onClick={createProfile}
                className="bg-purple-600 text-white px-6 rounded-lg font-semibold hover:bg-purple-700"
              >
                Create
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // HOME SCREEN
  if (screen === 'home' && currentProfile) {
    const myWorkouts = allWorkouts.filter(w => w.profileId === currentProfile.id);
    const stats = {
      total: myWorkouts.length,
      A: myWorkouts.filter(w => w.type === 'A').length,
      B: myWorkouts.filter(w => w.type === 'B').length,
      C: myWorkouts.filter(w => w.type === 'C').length
    };

    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-6">
        <div className="max-w-7xl mx-auto">
          <div className="flex justify-between items-center mb-8">
            <div>
              <h1 className="text-3xl font-bold text-white">Hey {currentProfile.name}! ðŸ’ª</h1>
              <p className="text-purple-300">Phase 1 Program</p>
            </div>
            <button
              onClick={() => { setCurrentProfile(null); setScreen('profiles'); }}
              className="text-purple-300 hover:text-white"
            >
              Switch Profile
            </button>
          </div>

          <div className="grid grid-cols-4 gap-4 mb-8">
            <div className="bg-white/10 border border-white/20 rounded-lg p-4">
              <div className="text-purple-300 text-sm">Total</div>
              <div className="text-white text-3xl font-bold">{stats.total}</div>
            </div>
            <div className="bg-white/10 border border-white/20 rounded-lg p-4">
              <div className="text-purple-300 text-sm">Workout A</div>
              <div className="text-white text-3xl font-bold">{stats.A}</div>
            </div>
            <div className="bg-white/10 border border-white/20 rounded-lg p-4">
              <div className="text-purple-300 text-sm">Workout B</div>
              <div className="text-white text-3xl font-bold">{stats.B}</div>
            </div>
            <div className="bg-white/10 border border-white/20 rounded-lg p-4">
              <div className="text-purple-300 text-sm">Workout C</div>
              <div className="text-white text-3xl font-bold">{stats.C}</div>
            </div>
          </div>

          <div className="mb-8">
            <h2 className="text-xl font-bold text-white mb-4">Start Workout</h2>
            <div className="grid grid-cols-3 gap-4">
              {['A', 'B', 'C'].map(type => (
                <button
                  key={type}
                  onClick={() => startWorkout(type)}
                  className="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-8 rounded-lg text-2xl font-bold hover:from-purple-700 hover:to-pink-700"
                >
                  Workout {type}
                </button>
              ))}
            </div>
          </div>

          <h2 className="text-xl font-bold text-white mb-4">History</h2>
          {allWorkouts.length > 0 ? (
            <div className="bg-white/10 border border-white/20 rounded-lg overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-white/5">
                  <tr>
                    <th className="text-left text-purple-300 p-3">Date</th>
                    <th className="text-left text-purple-300 p-3">Person</th>
                    <th className="text-left text-purple-300 p-3">Type</th>
                    {WORKOUTS.A.map((ex, i) => (
                      <th key={i} className="text-left text-purple-300 p-3 whitespace-nowrap">{ex.name}</th>
                    ))}
                    <th className="text-left text-purple-300 p-3">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {allWorkouts.map((w, idx) => (
                    <tr key={w.id} className={idx % 2 === 0 ? 'bg-white/5' : ''}>
                      <td className="text-white p-3 whitespace-nowrap">{new Date(w.date).toLocaleDateString()}</td>
                      <td className="text-purple-200 p-3">{w.profileName}</td>
                      <td className="p-3">
                        <span className="bg-purple-600 px-2 py-1 rounded text-white text-xs font-bold">{w.type}</span>
                      </td>
                      {w.exercises.map((ex, i) => {
                        const bestSet = ex.sets.reduce((best, s) => {
                          if (!s.reps) return best;
                          if (!best.reps) return s;
                          return (parseInt(s.reps) * (parseInt(s.weight) || 1)) > 
                                 (parseInt(best.reps) * (parseInt(best.weight) || 1)) ? s : best;
                        }, {});
                        return (
                          <td key={i} className="text-purple-200 p-3 text-xs">
                            {bestSet.reps ? (
                              <div>
                                <div className="text-white font-bold">{bestSet.reps}r</div>
                                {bestSet.weight && <div>{bestSet.weight}lb</div>}
                                {bestSet.effort !== null && <div className="text-purple-400">{EFFORT[bestSet.effort].split(' ')[0]}</div>}
                              </div>
                            ) : '-'}
                          </td>
                        );
                      })}
                      <td className="p-3">
                        {w.profileId === currentProfile.id && (
                          <button onClick={() => deleteWorkout(w.id)} className="text-red-400 hover:text-red-300">
                            <Trash2 size={16} />
                          </button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ) : (
            <div className="text-center text-purple-300 py-12">No workouts yet!</div>
          )}
        </div>
      </div>
    );
  }

  // WORKOUT SCREEN
  if (screen === 'workout' && activeWorkout) {
    const exercise = activeWorkout.exercises[exerciseIndex];
    const prevWorkout = getPreviousWorkout();
    const prevExercise = prevWorkout?.exercises[exerciseIndex];

    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
        <div className="sticky top-0 bg-slate-900/95 backdrop-blur p-4 border-b border-white/20 z-10">
          <div className="max-w-4xl mx-auto flex justify-between items-center">
            <div className="flex items-center gap-3">
              <button onClick={exitWorkout} className="text-purple-300 hover:text-white">
                <ChevronLeft size={24} />
              </button>
              <div>
                <h2 className="text-white font-bold text-lg">{exercise.name}</h2>
                <p className="text-purple-300 text-sm">Workout {activeWorkout.type} â€¢ {exerciseIndex + 1}/{activeWorkout.exercises.length}</p>
              </div>
            </div>
            <div className="flex gap-2">
              <button onClick={exitWorkout} className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                Exit
              </button>
              <button onClick={saveWorkout} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                <Save size={18} />
                Save
              </button>
            </div>
          </div>
        </div>

        <div className="max-w-4xl mx-auto p-4 pb-32">
          {prevExercise && (
            <div className="mb-6 bg-blue-900/30 border border-blue-500/30 rounded-lg p-4">
              <h3 className="text-blue-300 font-semibold mb-3 flex items-center gap-2">
                <TrendingUp size={18} />
                Last Time: {new Date(prevWorkout.date).toLocaleDateString()}
              </h3>
              <div className="grid grid-cols-3 gap-3">
                {prevExercise.sets.map((s, i) => (
                  <div key={i} className="bg-blue-950/50 rounded p-3 text-sm">
                    <div className="text-blue-200 mb-1">Set {i + 1}</div>
                    {s.reps ? (
                      <>
                        <div className="text-white font-bold">{s.reps} reps</div>
                        {s.weight && <div className="text-blue-300">{s.weight} lbs</div>}
                        {s.effort !== null && <div className="text-blue-400 text-xs">{EFFORT[s.effort]}</div>}
                      </>
                    ) : (
                      <div className="text-blue-400 italic">Skipped</div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="space-y-4">
            {exercise.sets.map((set, i) => (
              <div key={i} className="bg-white/10 border border-white/20 rounded-lg p-5">
                <h3 className="text-white font-semibold mb-4">Set {i + 1} â€¢ Target: {exercise.target}</h3>
                
                <div className="grid grid-cols-2 gap-3 mb-4">
                  <div>
                    <label className="text-purple-300 text-sm block mb-1">Reps</label>
                    <input
                      type="number"
                      value={set.reps}
                      onChange={e => updateSet(i, 'reps', e.target.value)}
                      className="w-full bg-white/10 border border-white/20 rounded px-3 py-2 text-white text-lg"
                      placeholder="0"
                    />
                  </div>
                  <div>
                    <label className="text-purple-300 text-sm block mb-1">Weight (lbs)</label>
                    <input
                      type="number"
                      value={set.weight}
                      onChange={e => updateSet(i, 'weight', e.target.value)}
                      className="w-full bg-white/10 border border-white/20 rounded px-3 py-2 text-white text-lg"
                      placeholder="0"
                    />
                  </div>
                </div>

                <div>
                  <label className="text-purple-300 text-sm block mb-2">Effort</label>
                  <div className="grid grid-cols-4 gap-2">
                    {EFFORT.map((label, idx) => (
                      <button
                        key={idx}
                        onClick={() => updateSet(i, 'effort', idx)}
                        className={`py-2 px-1 rounded text-xs ${
                          set.effort === idx 
                            ? 'bg-purple-600 text-white' 
                            : 'bg-white/10 text-purple-300 hover:bg-white/20'
                        }`}
                      >
                        {label}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur border-t border-white/20 p-4">
          <div className="max-w-4xl mx-auto flex gap-3">
            {exerciseIndex > 0 && (
              <button
                onClick={() => setExerciseIndex(exerciseIndex - 1)}
                className="flex-1 bg-white/10 text-white py-3 rounded-lg font-semibold hover:bg-white/20"
              >
                Previous
              </button>
            )}
            {exerciseIndex < activeWorkout.exercises.length - 1 ? (
              <button
                onClick={() => setExerciseIndex(exerciseIndex + 1)}
                className="flex-1 bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 flex items-center justify-center gap-2"
              >
                Next <ChevronRight size={20} />
              </button>
            ) : (
              <button
                onClick={saveWorkout}
                className="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 flex items-center justify-center gap-2"
              >
                <Save size={20} /> Complete
              </button>
            )}
          </div>
        </div>
      </div>
    );
  }
}
